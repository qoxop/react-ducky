!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("immer"),require("redux"),require("react")):"function"==typeof define&&define.amd?define(["exports","immer","redux","react"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).reactDucky={},t.immer,t.Redux,t.React)}(this,(function(t,e,n,r){"use strict";function o(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var u=o(e),i=o(r),c=function(t,e){return c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},c(t,e)};function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}c(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var s=function(){return s=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},s.apply(this,arguments)};function f(t,e,n,r){return new(n||(n=Promise))((function(o,u){function i(t){try{a(r.next(t))}catch(t){u(t)}}function c(t){try{a(r.throw(t))}catch(t){u(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((r=r.apply(t,e||[])).next())}))}function l(t,e){var n,r,o,u,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return u={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u;function c(u){return function(c){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&u[0]?r.return:u[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,u[1])).done)return o;switch(r=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,r=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=e.call(t,i)}catch(t){u=[6,t],r=0}finally{n=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}}var d,v="invalid response ~",p="invalid request ~",h="typeError: fetcher need to return a promise ~",y="popstate",b="pushState",w="replaceState",g="__REDUX_DEVTOOLS_EXTENSION_COMPOSE__",m=window.dispatchEvent.bind(window),S=window.addEventListener.bind(window),_=JSON.parse,O=JSON.stringify,E=window.history,P=window.localStorage,j=window.sessionStorage,C=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===function(t){return Object.prototype.toString.call(t)}(t)},x=function(t){return"function"==typeof t},k=function(t){return null!==t&&"object"==typeof t},R=function(t){return k(t)&&x(t.then)&&x(t.catch)},I=function(t,e){if(t===e)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n=Object.keys(e);return n.every((function(n){return e[n]===t[n]}))&&n.length===Object.keys(t).length}return!1},N=(d=0,function(){return"u_".concat(d++).concat(Date.now().toString(36))}),T=function(t){return{get:function(){try{var e=j.getItem(t);return e?_(e).v:null}catch(t){return null}},set:function(e){j.setItem(t,O({v:e}))}}},U=!1,A="replace",D=N(),L="pageAction",$=function(){return A},q=function(){var t;return(null===(t=E.state)||void 0===t?void 0:t._key_)||D},H=function(t,e){var n=e||q(),r=j.getItem(n);if(r)try{return _(r).v}catch(t){console.warn(t)}return x(t)?t():t},M=function(t,e){var n=e||q();t.idx&&t.key?t.usr&&j.setItem(n,O({v:t.usr})):j.setItem(n,O({v:t}))},G=function(t){return t&&t.idx&&t.key?t.key:N()},V=function(t,e){var n;return!e||-1===(null==t?void 0:t._key_)||-1===(null===(n=null==t?void 0:t.usr)||void 0===n?void 0:n._key_)},K=function(){if(!U){var t=T("$route_stack"),e=t.get()||[q()],n={pushState:function(n){var r=q(),o=e.findIndex((function(t){return t===r}));if(o>-1){var u=e.splice(o+1,e.length-o-1,n);setTimeout((function(){for(var t=Object.keys(j),e=0,n=u;e<n.length;e++){for(var r=n[e],o=[],i=0,c=t;i<c.length;i++){var a=c[i];0===a.indexOf(r)?j.removeItem(a):o.push(a)}t=o}}),1e3/60)}else e.push(n);t.set(e)},replaceState:function(n){var r=q(),o=e.findIndex((function(t){return t===r}));e[o]=n,t.set(e)}},r=q(),o=function(t){var n=q();switch(t){case b:A="push";break;case w:A="replace";break;default:var o=e.findIndex((function(t){return t===r})),u=e.findIndex((function(t){return t===n}));A=o>u?"goBack":"forward"}var i=new Event(L);i["_".concat(L)]=A,m(i),r=n};E.pushState=u(b),E.replaceState=u(w),S(y,(function(){return o(y)})),U=!0}function u(t){var e=E[t];return function(r,u,i){var c=function(t,e){return s(s({},t),{_key_:V(t,e)?q():G(t)})}(r,i);r&&M(r,c._key_),null!=i?(n[t](c._key_),e.call(this,c,u||"",i)):e.call(this,c,u||"",i),o(t)}}},B=Object.freeze({__proto__:null,EventName:L,getPageId:q,getPageState:H,setPageState:M,enhanceHistory:K,getCurrentPageAction:$});function J(t,e,n){this.valueOf=function(){return t},"string"==typeof t&&(this.toString=function(){return t}),this[e]=n}var X=function(t,e,n){var r;return t&&"object"==typeof t?Object.assign(C(t)?[]:{},t,((r={})[e]=n,r)):new J(t,e,n)};var z="ROUTE-CHANGED";var F=null,Y=function(){return function(){if(!F)throw new Error("Store 未初始化");return!0}()&&F},Q=function(t){return F=t},W=function(t,e){var r=e&&Object.keys(e).length?n.combineReducers(e):function(t){return t};return function(e,n){if(n.type===z)return s(s({},e),{_CURRENT_ROUTE:n.payload});var o=e._CURRENT_ROUTE,u=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}(e,["_CURRENT_ROUTE"]);return s(s({},t[n.type]?t[n.type](u,n):r(u,n)),{_CURRENT_ROUTE:o})}};var Z,tt=function(){function t(){this.equal={},this.match=[]}return t.prototype.addCase=function(t,e){return this.equal[t]?console.warn("action type duplicate ~"):this.equal[t]=e,this},t.prototype.addMatcher=function(t,e){return this.match.push({reducer:e,matcher:t}),this},t.prototype.addDefaultCase=function(t){return this.default=t,this},t}();function et(){var t={resolve:null,reject:null,promise:null};return t.promise=new Promise((function(e,n){t.resolve=e,t.reject=n})),t}function nt(t){return f(this,void 0,void 0,(function(){return l(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,t];case 1:return[2,[e.sent(),null]];case 2:return[2,[null,e.sent()]];case 3:return[2]}}))}))}function rt(t){var e=this,n=t.fetcher,r=t.after,o=t.before,u=t.identifier,i={};return function(){for(var t=[],c=0;c<arguments.length;c++)t[c]=arguments[c];return f(e,void 0,void 0,(function(){var e,c,a,s,f,d;return l(this,(function(l){switch(l.label){case 0:return e=u?u.apply(void 0,t):"def",c=n.apply(void 0,t),o&&o.apply(void 0,t),i[e]=(i[e]||0)+1,a=i[e],[4,nt(c)];case 1:if(s=l.sent(),f=s[0],d=s[1],a===i[e]){if(r&&r([f,t,d]),d)throw d;return[2,f]}throw new Error(v)}}))}))}}!function(t){t[t.LOADING=1]="LOADING",t[t.UNACTIVE=2]="UNACTIVE"}(Z||(Z={}));var ot=Symbol("PENDING_KEY"),ut=function(t){return!(!t||!0!==t[ot])},it=function(t,e){return e?X(t,ot,!0):function(t,e){var n;return t&&e in t&&delete t[e],null!==(n=null==t?void 0:t.valueOf())&&void 0!==n?n:t}(t,ot)},ct=function(t){function e(e){var n=t.call(this)||this;return n.getState=function(t){return t?t(n.store.getState()):n.store.getState()},n.store=e,n.startListen(),n}return a(e,t),e.prototype.startListen=function(){var t,e=this;this.unsubscribe||(this.unsubscribe=this.store.subscribe((function(){e.emit(e.store.getState(),!0);var n=t=function(){return e.emit(e.store.getState(),!1)};Promise.resolve().then((function(){t===n&&t()}))})))},e.prototype.destroy=function(){this.clear(),this.unsubscribe&&this.unsubscribe(),this.unsubscribe=null},e}(function(){function t(){this.listeners=new Map}return t.prototype.emit=function(t,e){this.listeners.forEach((function(n,r,o){if(!!n.sync===e){var u=n.callback(t);n.once&&u&&o.delete(r)}}))},t.prototype.add=function(t,e,n){this.listeners.set(t,s({callback:e},n))},t.prototype.remove=function(t){this.listeners.delete(t)},t.prototype.has=function(t){return this.listeners.has(t)},t.prototype.clear=function(){this.listeners.clear()},t}()),at=i.default.useRef,st=i.default.createContext,ft=i.default.useLayoutEffect,lt=st({}),dt=function(t){var e=t.store,n=t.children,r=t.setDefault,o=void 0!==r&&r,u=at({store:e,subscriber:null});return u.current.subscriber||(o&&Q(e),u.current.subscriber=new ct(e)),ft((function(){return u.current.subscriber.startListen(),u.current.subscriber.destroy.bind(u.current.subscriber)}),[u]),i.default.createElement(lt.Provider,{value:u.current},n)},vt=i.default.useState,pt=i.default.useReducer,ht=i.default.createContext,yt=Symbol?Symbol("$setState"):"$__controller_$_set_state",bt=Symbol?Symbol("$forceUpdate"):"$__controller_$_force_update",wt=Symbol?Symbol("$classHooks"):"$__controller_$_class_hooks",gt=Symbol?Symbol("$bindThis"):"$__controller_$_bind_this";var mt=function(){function t(t){var e=this;this.state={},this.props={},this.setState=function(t){return e[yt](t)},this.forceUpdate=function(){return e[bt]()},t&&(this.props=t),this[gt]&&this[gt](this)}return t.prototype.useHooks=function(){return{}},t.prototype[wt]=function(t){var n=vt(this.state),r=n[0],o=n[1];this[bt]=pt((function(t){return t+1}),0)[1],this.state=r,this.props=t,this[yt]||(this[yt]=function(t){o("function"==typeof t?e.produce(t):function(e){return s(s({},e),t)})})},t.Context=ht(null),t}(),St=function(t){function e(e,n){var r=t.call(this,n)||this;return r.store=e,r.dispatch=e.dispatch,r}return a(e,t),e}(mt),_t=i.default.useRef,Ot=i.default.useMemo,Et=i.default.useEffect,Pt=i.default.useContext,jt=i.default.useReducer,Ct=i.default.useCallback;function xt(t,e){void 0===e&&(e={});var n=Ot((function(){return{eq:e.eq||I,sync:e.sync,withSuspense:!0===e.withSuspense?ut:x(e.withSuspense)?e.withSuspense:null}}),[]),r=n.eq,o=n.withSuspense,u=n.sync,i=Pt(lt),c=i.subscriber,a=i.store,s=jt((function(t){return t+1}),0),f=s[0],l=s[1],d=Ot((function(){return t(a.getState())}),[a,f]),v=_t(d);if(Et((function(){var e=Symbol("use-selector"),n=t(a.getState());return r(n,v.current)||(Promise.resolve().then(l),v.current=n),c.add(e,(function(e){var n=t(e);r(n,v.current)||(v.current=n,l())}),{sync:u}),function(){return c.remove(e)}}),[a]),o&&o(d)){var p=et(),h=p.promise,y=p.resolve,b=Symbol("with-suspense");throw c.add(b,(function(e){var n=t(e);if(!o(n))return y(n),!0}),{once:!0}),h}return d}function kt(t){var e=_t(t);return e.current!==t&&(e.current=t),e}function Rt(t){var e=jt((function(t){return t+1}),0);e[0];var n=e[1],r=_t(function(t){return x(t)?t():t}(t)),o=Ct((function(t,e){x(t)?r.current=t(r.current):r.current=t,e||n()}),[]);return[r.current,o,r]}var It=function(t){if(t.cacheKey){var e=t.cacheKey,n=t.cacheStorage,r=void 0===n?"session":n,o=null;return{storeItem:o="session"===r?T(e):function(t,e,n){var r={get:function(){try{var n=t.getItem(e);return n?_(n).v:null}catch(t){return null}},set:function(r){t.setItem(e,O({v:r,h:n}))}};try{_(t.getItem(e)||"{}").h!==n&&r.set(null)}catch(t){r.set(null)}return r}("local"===r?P:r,e,t.cacheVersion||O(t.initialState)),state:o.get()||t.initialState}}return{storeItem:null,state:t.initialState}};var Nt=i.default.useState,Tt=i.default.useEffect;t.Builder=tt,t.Controller=mt,t.DuckyProvider=function(t){var e=t.store,n=t.children;return i.default.createElement(dt,{store:e,setDefault:!0},n)},t.ReduxContext=lt,t.ReduxController=St,t.ReduxProvider=dt,t.alwayResolve=nt,t.createFetchHandler=rt,t.createModel=function(t,n){void 0===n&&(n=Y);for(var r,o,i,c=t.statePaths,a=t.reducers,f=t.fetch,l=t.extraReducers,d=c.join("_").toUpperCase(),v=(r=c,void 0===o&&(o=null),function(t){for(var e=t,n=0,u=r;n<u.length;n++){var i=u[n];if(!e)return o;e=e[i]}return e}),p=function(){return n().dispatch},h={},y={},b=It(t),w=b.state,g=b.storeItem,m=new tt,S=function(t){var e=a[t],n="".concat(d,"/").concat(t);m.addCase(n,e),h[t]=function(t){return p()(s(s({},t&&"object"==typeof t?t:{}),{type:n,payload:t}))}},_=0,O=Object.getOwnPropertyNames(a);_<O.length;_++){S(O[_])}if(l)if("function"==typeof l)l(m);else if("object"==typeof l)for(var E=0,P=Object.getOwnPropertyNames(l);E<P.length;E++){var j=P[E];m.addCase(j,l[j])}if(f&&"object"==typeof f)for(var C=function(t){var n=f[t],r="".concat(d,"/fetching-").concat(t),o="".concat(d,"/fetched-").concat(t);y[t]=rt({fetcher:n,after:function(t){var e=t[0];t[1];var n=t[2];p()({type:o,data:e,error:n})},before:function(){p()({type:r})}}),m.addCase(r,(function(e){e[t]=it(e[t],!0)})),m.addCase(o,(function(n,r){var o,u=r.data,i=r.error;if(i){var c=null===(o=n[t])||void 0===o?void 0:o.valueOf();try{var a=c?it(e.current(n[t]),!1):c;n[t]=X(a,"error",i)}catch(i){n[t]=X(c,"error",i)}}else n[t]=u}))},k=0,R=Object.getOwnPropertyNames(f);k<R.length;k++){C(R[k])}i=function(t,e){void 0===e&&(e={});var n=e.builder,r=e.callback,o=e.enhanceState,i=e.onChange;return x(o)&&(t=o(t)),n||(n=new tt),x(r)&&r(n),function(e,r){var o;null==e&&(e=t);var c=n.equal[r.type],a=e,s=!1;if(c)a=u.default(a,(function(t){var e=c(t,r);if(e)return e})),s=!0;else if(null===(o=n.match)||void 0===o?void 0:o.length){var f=n.match.filter((function(t){return t.matcher(r)}));f.length&&(a=u.default(a,(function(t){for(var e=null,n=0,o=f;n<o.length;n++)e=o[n].reducer(e||t,r);if(e)return e})),s=!0)}else x(n.default)&&(a=u.default(a,(function(t){var e=n.default(t,r);if(e)return e})),s=!0);return x(i)&&s&&i(a),a}}(w,{builder:m,onChange:function(t){w=t,g&&g.set(t)}});var I=function(){return v(n().getState())};return{fetch:y,actions:h,reducer:i,useModel:function(t,e){return xt((function(e){return t?t(v(e)):v(e)}),e)},getState:I,isPending:function(t){return ut((I()||{})[t])}}},t.createPaginationHandler=function(t){var e=this,n=t.fetcher,r=t.after,o=t.before,u=t.isReset,i=t.identifier,c={},a={};return function(){for(var t=[],s=0;s<arguments.length;s++)t[s]=arguments[s];return f(e,void 0,void 0,(function(){var e,s,f,d,y,b,w;return l(this,(function(l){switch(l.label){case 0:if(e=i?i.apply(void 0,t):"def",s=u.apply(void 0,t),f=null,!s&&c[e]!==Z.UNACTIVE&&c[e])throw new Error(p);return c[e]=Z.LOADING,a[e]=(a[e]||0)+1,f=n.apply(void 0,t),d=a[e],o&&o.apply(void 0,t),R(f)?[4,nt(f)]:[3,2];case 1:if(y=l.sent(),b=y[0],w=y[1],d===a[e]){if(c[e]=Z.UNACTIVE,r&&r([b,t,w]),w)throw w;return[2,b]}throw new Error(v);case 2:throw new Error(h)}}))}))}},t.ctrlEnhance=function(t){void 0===t&&(t={});var e=t.useCtx,n=void 0===e||e,r=t.bindThis,o=void 0!==r&&r;return function(t){if(n){var e=ht(null);Object.defineProperties(t,{Provider:{value:function(t){var n=t.controller,r=t.children;return i.default.createElement(e.Provider,{value:n},r)}},Context:{value:e}})}if(o){var r=Object.getOwnPropertyNames(t.prototype).filter((function(e){return"function"==typeof t.prototype[e]&&!/^use/.test(e)&&"constructor"!==e}));Object.defineProperty(t.prototype,gt,{value:function(e){for(var n=0;n<r.length;n++){var o=r[n];e[o]=t.prototype[o].bind(e)}}})}return t}},t.getStore=Y,t.historyHelper=B,t.historyMiddleware=function(t){var e=t.dispatch;return K(),window.addEventListener(L,(function(t){var n=window.location,r=n.search,o=n.pathname,u=n.hash,i=window.history.state;e({type:z,payload:{hash:u,state:i,search:r,pathname:o,method:t["_".concat(L)]}})})),function(t){return t}},t.initStore=function(t){var e=t.isDev,r=void 0!==e&&e,o=t.initState,u=void 0===o?{}:o,i=t.middleware,c=void 0===i?[]:i,a=t.reducerRecord,s=void 0===a?{}:a,f=t.rootReducers,l=void 0===f?{}:f,d=n.createStore(W(l,s),u,function(t,e){return void 0===e&&(e=!1),(e&&window[g]?window[g]:n.compose)(n.applyMiddleware.apply(void 0,t))}(c,r));return F||(F=d),{updateReducer:function(t,e){void 0===e&&(e=!1);var n=!1;for(var r in t)!Object.prototype.hasOwnProperty.call(t,r)||s[r]&&!e||(s[r]=t[r],n=!0);n&&d.replaceReducer(W(l,s))},store:d}},t.isEmpty=function(t){return!t||!(null==t?void 0:t.valueOf())||(C(t)?0===t.length:!!k(t)&&0===Object.getOwnPropertyNames(t).length)},t.isPending=ut,t.outPromise=et,t.setPending=it,t.setStore=Q,t.thunkMiddleware=function(t){var e=t.getState;return function(t){return function(n){return x(n)?n(t,e):t(n)}}},t.useController=function(t,e){var n=Ot((function(){return new t(e)}),[]);n[wt](e);var r=n.useHooks();return[n,r]},t.useCtrlContext=function(t){return Pt(t.Context)},t.useDispatch=function(){return Pt(lt).store.dispatch},t.usePageEffect=function(t){var e=_t(!1),n=kt(t);e.current||(e.current=!0,x(n.current.onEnter)&&n.current.onEnter($())),Et((function(){x(n.current.onEnterEffect)&&n.current.onEnterEffect($());var t=n.current.onLeave;return function(){x(t)&&Promise.resolve().then((function(){try{t($())}catch(t){console.warn(t)}}))}}),[])},t.usePageState=function(t,e){void 0===e&&(e="");var n=Ot((function(){return"".concat(q()).concat(e)}),[]),r=Rt((function(){return H(t,n)})),o=r[0],u=r[1],i=r[2],c=Ct((function(){return M(i.current,n)}),[]);return Et((function(){return window.addEventListener("beforeunload",c),function(){c(),window.removeEventListener("beforeunload",c)}}),[]),[o,u]},t.usePropRef=kt,t.useReduxController=function(t,e){var n=Pt(lt).store,r=Ot((function(){return new t(n,e)}),[]);r[wt](e);var o=r.useHooks();return[r,o]},t.useSelector=xt,t.useStateRef=Rt,t.withPageHook=function(t,e){var n=e.onEnter,r=e.onLeave;return function(e){var o=Nt(!1),u=o[0],c=o[1];return Tt((function(){return Promise.resolve().then((function(){return c(!0)})),x(n)&&n($()),function(){Promise.resolve().then((function(){x(r)&&r($())}))}}),[]),u?i.default.createElement(t,s({},e)):null}},Object.defineProperty(t,"__esModule",{value:!0})}));
